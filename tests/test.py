import json
import logging

import pytest

from actions.actions import Actions
from utils.json_parser import JsonParser

ACTUAL_JSON_OBJ = """{"start":1554371401,"relations":[{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["8eb256f1-5785-11e9-b543-0242abe9b27"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["e81f5601-5787-11e9-9f06-0242026a90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["e65a4a41-5783-11e9-b0c1-0242026aa90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["983396b1-5787-11e9-9090-0242abe9b297"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_2.phase-1","accesses":["write"],"runs":["e65a4a41-5783-11e9-b0c1-0242026aa90e"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["e65a4a41-5783-11e9-b0c1-0242026aa90e"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["8eb256f1-5785-11e9-b543-0242abe9b297"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_1.phase-1","accesses":["write"],"runs":["983396b1-5787-11e9-9090-0242abe9b297"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["983396b1-5787-11e9-9090-0242abe9b297"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_2.phase-1","accesses":["write"],"runs":["8eb256f1-5785-11e9-b543-0242abe9b297"],"components":[]},{"data":"dataset.default.purchases.csv","program":"mapreduce.default.dummy_v1.phase-1","accesses":["read"],"runs":["05442791-56db-11e9-a2c0-024283865e4d"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_1.phase-1","accesses":["write"],"runs":["f488c8f1-5786-11e9-b20c-0242026aa90e"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["f488c8f1-5786-11e9-b20c-0242026aa90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["e81f5601-5787-11e9-9f06-0242026aa90e"],"components":[]},{"data":"dataset.default.result","program":"mapreduce.default.dummy_v1.phase-1","accesses":["write"],"runs":["05442791-56db-11e9-a2c0-024283865e4d"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_1.phase-1","accesses":["write"],"runs":["e81f5601-5787-11e9-9f06-0242026aa90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["f488c8f1-5786-11e9-b20c-0242026aa90e"],"components":[]}],"programs":{"spark.default.joinerAttempt_1.phase-1":{"entityId":{"application":"joinerAttempt_1","version":"-SNAPSHOT","type":"Spark","program":"phase-1","namespace":"default","entity":"PROGRAM"}},"spark.default.joinerAttempt_2.phase-1":{"entityId":{"application":"joinerAttempt_2","version":"-SNAPSHOT","type":"Spark","program":"phase-1","namespace":"default","entity":"PROGRAM"}},"mapreduce.default.dummy_v1.phase-1":{"entityId":{"application":"dummy_v1","version":"-SNAPSHOT","type":"Mapreduce","program":"phase-1","namespace":"default","entity":"PROGRAM"}}},"data":{"dataset.default.result":{"entityId":{"dataset":"result","namespace":"default","entity":"DATASET"}},"dataset.default.customers.csv":{"entityId":{"dataset":"customers.csv","namespace":"default","entity":"DATASET"}},"dataset.default.purchases.csv":{"entityId":{"dataset":"purchases.csv","namespace":"default","entity":"DATASET"}},"dataset.default.Joiner_Dataset":{"entityId":{"dataset":"Joiner_Dataset","namespace":"default","entity":"DATASET"}}}}"""
EXPECTED_JSON_OBJ = """{"start1":1371401, "end":1554457806, "start":155437141,"relations":[{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["8eb256f1-5785-11e9-b543-0242abe9b27"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["e81f5601-5787-11e9-9f06-0242026a90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["e65a4a41-5783-11e9-b0c1-0242026aa90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["983396b1-5787-11e9-9090-0242abe9b297"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_2.phase-1","accesses":["write"],"runs":["e65a4a41-5783-11e9-b0c1-0242026aa90e"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["e65a4a41-5783-11e9-b0c1-0242026aa90e"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_2.phase-1","accesses":["read"],"runs":["8eb256f1-5785-11e9-b543-0242abe9b297"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_1.phase-1","accesses":["write"],"runs":["983396b1-5787-11e9-9090-0242abe9b297"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["983396b1-5787-11e9-9090-0242abe9b297"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_2.phase-1","accesses":["write"],"runs":["8eb256f1-5785-11e9-b543-0242abe9b297"],"components":[]},{"data":"dataset.default.purchases.csv","program":"mapreduce.default.dummy_v1.phase-1","accesses":["read"],"runs":["05442791-56db-11e9-a2c0-024283865e4d"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_1.phase-1","accesses":["write"],"runs":["f488c8f1-5786-11e9-b20c-0242026aa90e"],"components":[]},{"data":"dataset.default.purchases.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["f488c8f1-5786-11e9-b20c-0242026aa90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["e81f5601-5787-11e9-9f06-0242026aa90e"],"components":[]},{"data":"dataset.default.result","program":"mapreduce.default.dummy_v1.phase-1","accesses":["write"],"runs":["05442791-56db-11e9-a2c0-024283865e4d"],"components":[]},{"data":"dataset.default.Joiner_Dataset","program":"spark.default.joinerAttempt_1.phase-1","accesses":["write"],"runs":["e81f5601-5787-11e9-9f06-0242026aa90e"],"components":[]},{"data":"dataset.default.customers.csv","program":"spark.default.joinerAttempt_1.phase-1","accesses":["read"],"runs":["f488c8f1-5786-11e9-b20c-0242026aa90e"],"components":[]}],"programs":{"spark.default.joinerAttempt_1.phase-1":{"entityId":{"application":"joinerAttempt_1","version":"-SNAPSHOT","type":"Spark","program":"phase-1","namespace":"default","entity":"PROGRAM"}},"spark.default.joinerAttempt_2.phase-1":{"entityId":{"application":"joinerAttempt_2","version":"-SNAPSHOT","type":"Spark","program":"phase-1","namespace":"default","entity":"PROGRAM"}},"mapreduce.default.dummy_v1.phase-1":{"entityId":{"application":"dummy_v1","version":"-SNAPSHOT","type":"Mapreduce","program":"phase-1","namespace":"default","entity":"PROGRAM"}}},"data":{"dataset.default.result":{"entityId":{"dataset":"result","namespace":"default","entity":"DATASET"}},"dataset.default.customers.csv":{"entityId":{"dataset":"customers.csv","namespace":"default","entity":"DATASET"}},"dataset.default.purchases.csv":{"entityId":{"dataset":"purchases.csv","namespace":"default","entity":"DATASET"}},"dataset.default.Joiner_Dataset":{"entityId":{"dataset":"Joiner_Dataset","namespace":"default","entity":"DATASET"}}}}"""


class TestApi(object):
    _logger = logging.getLogger(__name__)
    proxy_server_base_url = "http://192.168.134.195:1338"
    # test_header = {"X-ZINFO": "55556420:EzFOyd0zB6KmquoEAoxT1Q==", "X-VID": "CHRXNCLH0111",
    #                "X-AUTH": '{"mdn": "8436012163", "iat": "1550774158", "imsi": "311480420643009", "am": "pp", "des_ip":"2600:40ff:fff8:1:1:1:0:33:22790", "vsep_id": "CHRXNCLH0111", "src_ip": "2600:1004:b031:9979:6d84:cfa5:c861:4b31:38246"}',
    #                "X-Forwarded-For": "2600:1004:b031:9979:6d84:cfa5:c861:4b31", "X-Forwarded-Port": "38246"}
    test_header = {
        "X-AUTH": '{"mdn": "8436012163", "iat": "1550774158", "imsi": "311480420643009", "am": "pp", "des_ip":"2600:40ff:fff8:1:1:1:0:33:22790", "vsep_id": "CHRXNCLH0111", "src_ip": "2600:1004:b031:9979:6d84:cfa5:c861:4b31:38246"}',
        "X-Forwarded-For": "2600:1004:b031:9979:6d84:cfa5:c861:4b31", "X-Forwarded-Port": "38246"}

    @pytest.fixture(scope="session")
    def actions(self):
        return Actions(base_url=self.proxy_server_base_url, test_header=self.test_header).generate_request()

    def test_1(self, actions):
        assert str(json.loads(actions._content)['x-st']) == "PB"

    def test_2(self):
        response = JsonParser.json_diff(json.loads(ACTUAL_JSON_OBJ), json.loads(EXPECTED_JSON_OBJ),
                                        ignore=set(['start', 'end', 'start1']))
        print response

